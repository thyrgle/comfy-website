<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
  <meta name="description" content="Comfy is an ergonomic 2D game engine built in Rust. It's designed to be opinionated, productive, and easy to use.">

  <title>Comfy Engine</title>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-1DRWETLGBR"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-1DRWETLGBR');
  </script>

  <script>
    const savedTheme = localStorage.getItem('data-bs-theme');
    const preferredTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    const theme = savedTheme || preferredTheme;
    document.documentElement.setAttribute('data-bs-theme', theme);

    document.addEventListener('DOMContentLoaded', function () {
      const themeSwitch = document.getElementById('comfySwitch');

      // Set the checkbox state based on the current theme
      themeSwitch.checked = theme === 'dark';

      themeSwitch.addEventListener('change', function () {
        if (themeSwitch.checked) {
          document.documentElement.setAttribute('data-bs-theme', 'dark');
          localStorage.setItem('data-bs-theme', 'dark');
        } else {
          document.documentElement.setAttribute('data-bs-theme', 'light');
          localStorage.setItem('data-bs-theme', 'light');
        }
      });
    });
  </script>

  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Fira+Sans:wght@400;700&display=swap" />

  <!-- <link -->
  <!--   href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" -->
  <!--   rel="stylesheet" -->
  <!--   integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" -->
  <!--   crossorigin="anonymous" -->
  <!-- /> -->

  <link rel="stylesheet" href="/style.css" />
</head>

<body>
  <div class="container mb-4">
    <header class="d-flex flex-wrap justify-content-center py-3 mb-4 border-bottom">
      <a href="/" class="d-flex align-items-center mb-3 mb-md-0 me-md-auto link-body-emphasis text-decoration-none">
        <img src="/comfy.png" alt="logo of the comfy engine" class="bi me-2" width="32" height="32" />
        <span class="fs-4"><strong>Comfy</strong></span>
      </a>

      <ul class="nav nav-pills">
        <li class="nav-item">
          <a href="/book" class="nav-link">Book</a>
        </li>
        <li class="nav-item">
          <a href="/features" class="nav-link">Features</a>
        </li>
        <li class="nav-item"><a href="/examples" class="nav-link">Examples</a></li>
        <li class="nav-item"><a href="/blog" class="nav-link">Blog</a></li>
        <li class="nav-item">
          <a href="https://github.com/darthdeus/comfy" class="">
            <img class="light-github" width="40" height="40" src="/github-mark.svg" alt="Github repo" />
            <img class="dark-github" width="40" height="40" src="/github-mark-white.svg" alt="Github repo" />
          </a>
        </li>
        <li class="nav-item mx-2">
          <a href="https://discord.gg/6NGGGTUz7x" class="">
            <img class="light-discord" height="40" src="/discord-mark-black.png" alt="Discord" />
            <img class="dark-discord" height="40" src="/discord-mark-white.png" alt="Discord" />
          </a>
        </li>

        <li class="ms-3 my-2">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" role="switch" id="comfySwitch" style="cursor: pointer">
            <label class="form-check-label" for="comfySwitch">Dark Theme</label>
          </div>
        </li>
      </ul>

    </header>

    <section class="section">
      <div class="container">
<h1 class="title">ldtk</h1>
<p class="subtitle"><strong>2023-12-08</strong></p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#b48ead;">use </span><span>comfy::*;
</span><span>simple_game!(&quot;</span><span style="color:#a3be8c;">LDTK Example</span><span>&quot;, GameState, setup, update);
</span><span style="color:#b48ead;">const </span><span style="color:#d08770;">LDTK_PATH</span><span>: &amp;</span><span style="color:#b48ead;">str </span><span>= &quot;</span><span style="color:#a3be8c;">assets/comfy_ldtk.ldtk</span><span>&quot;;
</span><span>
</span><span style="color:#b48ead;">pub struct </span><span>GameState {
</span><span>    </span><span style="color:#b48ead;">pub </span><span style="color:#bf616a;">ldtk_map</span><span>: LdtkWorldMap,
</span><span>}
</span><span>
</span><span style="color:#b48ead;">impl </span><span>GameState {
</span><span>    </span><span style="color:#b48ead;">pub fn </span><span style="color:#8fa1b3;">new</span><span>(</span><span style="color:#bf616a;">_c</span><span>: &amp;EngineState) -&gt; </span><span style="color:#b48ead;">Self </span><span>{
</span><span>        </span><span style="color:#b48ead;">Self </span><span>{
</span><span>            ldtk_map: LdtkWorldMap::new(
</span><span>                </span><span style="color:#96b5b4;">parse_ldtk_map</span><span>(include_str!(&quot;</span><span style="color:#a3be8c;">../../assets/comfy_ldtk.ldtk</span><span>&quot;))
</span><span>                    .</span><span style="color:#96b5b4;">unwrap</span><span>(),
</span><span>                </span><span style="color:#d08770;">LDTK_PATH</span><span>,
</span><span>            ),
</span><span>        }
</span><span>    }
</span><span>}
</span><span>
</span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">setup</span><span>(</span><span style="color:#bf616a;">_state</span><span>: &amp;</span><span style="color:#b48ead;">mut</span><span> GameState, </span><span style="color:#bf616a;">c</span><span>: &amp;</span><span style="color:#b48ead;">mut</span><span> EngineContext) {
</span><span>    c.</span><span style="color:#96b5b4;">load_texture_from_bytes</span><span>(
</span><span>        &quot;</span><span style="color:#a3be8c;">comfy</span><span>&quot;,
</span><span>        include_bytes!(concat!(
</span><span>            env!(&quot;</span><span style="color:#a3be8c;">CARGO_MANIFEST_DIR</span><span>&quot;),
</span><span>            &quot;</span><span style="color:#a3be8c;">/../assets/comfy.png</span><span>&quot;
</span><span>        )),
</span><span>    );
</span><span>
</span><span>    c.</span><span style="color:#96b5b4;">load_texture_from_bytes</span><span>(
</span><span>        &quot;</span><span style="color:#a3be8c;">tileset</span><span>&quot;,
</span><span>        include_bytes!(concat!(
</span><span>            env!(&quot;</span><span style="color:#a3be8c;">CARGO_MANIFEST_DIR</span><span>&quot;),
</span><span>            &quot;</span><span style="color:#a3be8c;">/../assets/tiles.png</span><span>&quot;
</span><span>        )),
</span><span>    );
</span><span>}
</span><span>
</span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">update</span><span>(</span><span style="color:#bf616a;">state</span><span>: &amp;</span><span style="color:#b48ead;">mut</span><span> GameState, </span><span style="color:#bf616a;">_c</span><span>: &amp;</span><span style="color:#b48ead;">mut</span><span> EngineContext) {
</span><span>    </span><span style="color:#96b5b4;">clear_background</span><span>(</span><span style="color:#d08770;">AQUAMARINE</span><span>);
</span><span>
</span><span>    </span><span style="color:#b48ead;">let</span><span> map = &amp;state.ldtk_map.json;
</span><span>    </span><span style="color:#b48ead;">let</span><span> level = &amp;map.levels[</span><span style="color:#d08770;">0</span><span>];
</span><span>    </span><span style="color:#b48ead;">for </span><span>(i, layer) in
</span><span>        level.layer_instances.</span><span style="color:#96b5b4;">as_ref</span><span>().</span><span style="color:#96b5b4;">unwrap</span><span>().</span><span style="color:#96b5b4;">iter</span><span>().</span><span style="color:#96b5b4;">rev</span><span>().</span><span style="color:#96b5b4;">enumerate</span><span>()
</span><span>    {
</span><span>        </span><span style="color:#b48ead;">let</span><span> grid_size = layer.grid_size as </span><span style="color:#b48ead;">f32</span><span>;
</span><span>
</span><span>        </span><span style="color:#b48ead;">let</span><span> tileset = layer
</span><span>            .tileset_def_uid
</span><span>            .</span><span style="color:#96b5b4;">and_then</span><span>(|</span><span style="color:#bf616a;">uid</span><span>| map.defs.tilesets.</span><span style="color:#96b5b4;">iter</span><span>().</span><span style="color:#96b5b4;">find</span><span>(|</span><span style="color:#bf616a;">t</span><span>| t.uid == uid));
</span><span>
</span><span>        </span><span style="color:#b48ead;">if let </span><span>Some(_tileset) = tileset {
</span><span>            </span><span style="color:#b48ead;">let</span><span> texture = </span><span style="color:#96b5b4;">texture_id</span><span>(&quot;</span><span style="color:#a3be8c;">tileset</span><span>&quot;);
</span><span>
</span><span>            </span><span style="color:#65737e;">// WORLD - TILES
</span><span>            </span><span style="color:#b48ead;">for</span><span> tile in layer.grid_tiles.</span><span style="color:#96b5b4;">iter</span><span>() {
</span><span>                </span><span style="color:#b48ead;">let</span><span> pos = tile.</span><span style="color:#96b5b4;">to_world</span><span>(layer);
</span><span>
</span><span>                </span><span style="color:#96b5b4;">draw_sprite_ex</span><span>(
</span><span>                    texture,
</span><span>                    pos,
</span><span>                    </span><span style="color:#d08770;">WHITE</span><span>,
</span><span>                    </span><span style="color:#d08770;">10 </span><span>+ i as </span><span style="color:#b48ead;">i32</span><span>,
</span><span>                    DrawTextureParams {
</span><span>                        dest_size: Some(
</span><span>                            </span><span style="color:#96b5b4;">splat</span><span>(grid_size / </span><span style="color:#d08770;">16.0</span><span>).</span><span style="color:#96b5b4;">as_world_size</span><span>(),
</span><span>                        ),
</span><span>                        source_rect: Some(IRect::new(
</span><span>                            </span><span style="color:#96b5b4;">ivec2</span><span>(tile.src[</span><span style="color:#d08770;">0</span><span>] as </span><span style="color:#b48ead;">i32</span><span>, tile.src[</span><span style="color:#d08770;">1</span><span>] as </span><span style="color:#b48ead;">i32</span><span>),
</span><span>                            </span><span style="color:#96b5b4;">ivec2</span><span>(grid_size as </span><span style="color:#b48ead;">i32</span><span>, grid_size as </span><span style="color:#b48ead;">i32</span><span>),
</span><span>                        )),
</span><span>                        flip_x: tile.f == </span><span style="color:#d08770;">1 </span><span>|| tile.f == </span><span style="color:#d08770;">3</span><span>,
</span><span>                        flip_y: tile.f == </span><span style="color:#d08770;">2 </span><span>|| tile.f == </span><span style="color:#d08770;">3</span><span>,
</span><span>                        ..Default::default()
</span><span>                    },
</span><span>                );
</span><span>            }
</span><span>        }
</span><span>
</span><span>        </span><span style="color:#65737e;">// CHARACTERS - ENTITIES
</span><span>        </span><span style="color:#b48ead;">for</span><span> entity in layer.entity_instances.</span><span style="color:#96b5b4;">iter</span><span>() {
</span><span>            </span><span style="color:#b48ead;">if</span><span> entity.identifier == &quot;</span><span style="color:#a3be8c;">Character</span><span>&quot; {
</span><span>                </span><span style="color:#b48ead;">let</span><span> center = entity.</span><span style="color:#96b5b4;">world_pos</span><span>(layer.</span><span style="color:#b48ead;">c_hei</span><span>, layer.grid_size);
</span><span>                </span><span style="color:#b48ead;">let</span><span> size = entity.</span><span style="color:#96b5b4;">world_size</span><span>(layer.grid_size);
</span><span>
</span><span>                </span><span style="color:#96b5b4;">draw_rect</span><span>(center, size, </span><span style="color:#d08770;">RED</span><span>.</span><span style="color:#96b5b4;">alpha</span><span>(</span><span style="color:#d08770;">0.5</span><span>), </span><span style="color:#d08770;">100</span><span>);
</span><span>                </span><span style="color:#96b5b4;">draw_text</span><span>(
</span><span>                    entity.</span><span style="color:#96b5b4;">str_field</span><span>(&quot;</span><span style="color:#a3be8c;">Name</span><span>&quot;).</span><span style="color:#96b5b4;">unwrap_or_default</span><span>(),
</span><span>                    center,
</span><span>                    </span><span style="color:#d08770;">BLACK</span><span>,
</span><span>                    TextAlign::Center,
</span><span>                );
</span><span>            } </span><span style="color:#b48ead;">else </span><span>{
</span><span>                error!(&quot;</span><span style="color:#a3be8c;">Missing: entity {:?}</span><span>&quot;, entity);
</span><span>            }
</span><span>        }
</span><span>    }
</span><span>}
</span><span>
</span><span>
</span><span style="color:#65737e;">// pub fn draw_ldtk_map(ldtk: &amp;LdtkWorldMap, spatial: &amp;mut SpatialHash) {
</span><span style="color:#65737e;">//     let map = &amp;ldtk.json;
</span><span style="color:#65737e;">//     let level = &amp;map.levels[0];
</span><span>
</span><span style="color:#65737e;">//     for (i, layer) in
</span><span style="color:#65737e;">//         level.layer_instances.as_ref().unwrap().iter().rev().enumerate()
</span><span style="color:#65737e;">//     {
</span><span style="color:#65737e;">//         let grid_size = layer.grid_size as f32;
</span><span>
</span><span style="color:#65737e;">//         if layer.layer_instance_type == &quot;IntGrid&quot; {
</span><span style="color:#65737e;">//             let grid = grid_from_csv(layer);
</span><span>
</span><span style="color:#65737e;">//             for y in 0..grid.height {
</span><span style="color:#65737e;">//                 for x in 0..grid.width {
</span><span style="color:#65737e;">//                     if grid[(x, y)] == 1 {
</span><span style="color:#65737e;">//                         let pos = layer.grid_to_world(x, y);
</span><span style="color:#65737e;">//                         spatial.add_shape(
</span><span style="color:#65737e;">//                             AabbShape::shape(pos, splat(1.0)),
</span><span style="color:#65737e;">//                             UserData::default(),
</span><span style="color:#65737e;">//                         );
</span><span style="color:#65737e;">//                     }
</span><span style="color:#65737e;">//                 }
</span><span style="color:#65737e;">//             }
</span><span style="color:#65737e;">//         }
</span><span>
</span><span style="color:#65737e;">//         let tileset = layer
</span><span style="color:#65737e;">//             .tileset_def_uid
</span><span style="color:#65737e;">//             .and_then(|uid| map.defs.tilesets.iter().find(|t| t.uid == uid));
</span><span>
</span><span style="color:#65737e;">//         if let Some(_tileset) = tileset {
</span><span style="color:#65737e;">//             // let path = map.resolve_rel_level_path(tileset.rel_path.as_ref().unwrap());
</span><span style="color:#65737e;">//             // let texture = c.asset_loader.texture(&amp;path);
</span><span style="color:#65737e;">//             let texture = texture_id(&quot;camp&quot;);
</span><span>
</span><span style="color:#65737e;">//             for tile in layer.grid_tiles.iter() {
</span><span style="color:#65737e;">//                 // let pos = vec2(
</span><span style="color:#65737e;">//                 //     tile.px[0] as f32,
</span><span style="color:#65737e;">//                 //     //tile.px[1] as f32,
</span><span style="color:#65737e;">//                 //     (layer.c_hei as f32 - 1.0) * grid_size - tile.px[1] as f32,
</span><span style="color:#65737e;">//                 // );
</span><span>
</span><span style="color:#65737e;">//                 let pos = tile.to_world(layer);
</span><span>
</span><span style="color:#65737e;">//                 // draw_text_ex(
</span><span style="color:#65737e;">//                 //     &amp;format!(&quot;{:.0?}&quot;, pos),
</span><span style="color:#65737e;">//                 //     pos.as_world(),
</span><span style="color:#65737e;">//                 //     TextAlign::Center,
</span><span style="color:#65737e;">//                 //     TextParams {
</span><span style="color:#65737e;">//                 //         font: egui::FontId::new(
</span><span style="color:#65737e;">//                 //             8.0 / egui_scale_factor(),
</span><span style="color:#65737e;">//                 //             egui::FontFamily::Proportional,
</span><span style="color:#65737e;">//                 //         ),
</span><span style="color:#65737e;">//                 //         color: RED,
</span><span style="color:#65737e;">//                 //         ..Default::default()
</span><span style="color:#65737e;">//                 //     },
</span><span style="color:#65737e;">//                 // );
</span><span>
</span><span style="color:#65737e;">//                 draw_sprite_ex(
</span><span style="color:#65737e;">//                     texture,
</span><span style="color:#65737e;">//                     pos,
</span><span style="color:#65737e;">//                     // pos / 16.0,
</span><span style="color:#65737e;">//                     // WHITE.alpha(0.51),
</span><span style="color:#65737e;">//                     WHITE,
</span><span style="color:#65737e;">//                     10 + i as i32,
</span><span style="color:#65737e;">//                     DrawTextureParams {
</span><span style="color:#65737e;">//                         dest_size: Some(
</span><span style="color:#65737e;">//                             splat(grid_size / 16.0).as_world_size(),
</span><span style="color:#65737e;">//                         ),
</span><span style="color:#65737e;">//                         source_rect: Some(IRect::new(
</span><span style="color:#65737e;">//                             ivec2(tile.src[0] as i32, tile.src[1] as i32),
</span><span style="color:#65737e;">//                             ivec2(grid_size as i32, grid_size as i32),
</span><span style="color:#65737e;">//                         )),
</span><span style="color:#65737e;">//                         flip_x: tile.f == 1 || tile.f == 3,
</span><span style="color:#65737e;">//                         flip_y: tile.f == 2 || tile.f == 3,
</span><span style="color:#65737e;">//                         ..Default::default()
</span><span style="color:#65737e;">//                     },
</span><span style="color:#65737e;">//                 );
</span><span style="color:#65737e;">//             }
</span><span style="color:#65737e;">//         }
</span><span>
</span><span style="color:#65737e;">//         for entity in layer.entity_instances.iter() {
</span><span style="color:#65737e;">//             if entity.identifier == &quot;Zone&quot; {
</span><span style="color:#65737e;">//                 let center = entity.world_pos(layer.c_hei, layer.grid_size);
</span><span style="color:#65737e;">//                 let size = entity.world_size(layer.grid_size);
</span><span>
</span><span style="color:#65737e;">//                 draw_rect(center, size, RED.alpha(0.5), 100);
</span><span style="color:#65737e;">//             } else {
</span><span style="color:#65737e;">//                 error!(&quot;TODO: entity {:?}&quot;, entity);
</span><span style="color:#65737e;">//             }
</span><span style="color:#65737e;">//             // state.objects.create_or_update(
</span><span style="color:#65737e;">//             //     entity,
</span><span style="color:#65737e;">//             //     layer.c_hei as f32,
</span><span style="color:#65737e;">//             //     grid_size,
</span><span style="color:#65737e;">//             // );
</span><span style="color:#65737e;">//         }
</span><span style="color:#65737e;">//     }
</span><span style="color:#65737e;">// }
</span></code></pre>
 </div>
    </section>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous">
    </script>
</body>
</html>
